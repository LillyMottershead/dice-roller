<!DOCTYPE html>
<html>
    <head>
        <title>QuickRoll</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="static/style.css" />
        <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>  
        <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
        <script src="roll.js"></script>

        <script type="text/babel">
            class App extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        rollCommand: '',
                        times: '',
                        output: '',
                        aliases: JSON.parse(localStorage.aliases),
                        log: [],
                    };
                    this.textInputRef = React.createRef();
                    this.submit = this.submit.bind(this);
                    this.onRollFormChange = this.onRollFormChange.bind(this);
                }

                onRollFormChange = (e => {
                    const target = event.target;
                    const value = target.value;
                    const name = target.name;
                    this.setState({[name]: value});
                });
                submit = (e => {
                    e.preventDefault();
                    function getRolls(rollCommand, index) {
                        let output;
                        try {
                            output = command(rollCommand);
                            if (output.rolls) {
                                output = output.rolls.map((x,i) => <Roll key={`roll#${i}`} roll={x} />);
                            } else {
                                output = <div className='flex-child'>{output.message}</div>;
                            }
                        } catch(err) {
                            output = err;
                        }
                        return <Call key={`call#${index}`} rolls={output} />
                    }
                    let times = +this.state.times || 1;
                    let output = [...new Array(times).keys()].map((x,i) => getRolls(this.state.rollCommand, i));
                    this.setState({aliases: JSON.parse(localStorage.aliases)}); //todo: a way to do this only when the aliases change?
                    this.setState(state => state.log.push(output));
                    this.setState(({
                        rollCommand: '',
                        times: '',
                        output: output,
                    }));
                    this.textInputRef.current.focus();
                });
                
                render() {
                    console.log(this.state.log);
                    return (
                        <section>
                            <RollForm 
                                rollCommand={this.state.rollCommand} 
                                times={this.state.times} 
                                onRollFormChange={this.onRollFormChange} 
                                submit={this.submit}
                                textInputRef={this.textInputRef} />
                            <section className='h-container'>
                                {this.state.output}
                            </section>
                            <section className='h-container'>
                                <Aliases aliases={this.state.aliases} />
                                <Log />
                            </section>
                        </section>
                    )
                }
            }

            class RollForm extends React.Component {
                render() {
                    return (
                        <form>
                            <input className='input-text' type="text" ref={this.props.textInputRef} autoFocus name="rollCommand" value={this.props.rollCommand} onChange={this.props.onRollFormChange}/>
                            <input className='input-text' type="text" style={{width:'30px'}} name="times" value={this.props.times} onChange={this.props.onRollFormChange}/>
                            <input className='input' type="submit" value=">" onClick={this.props.submit} />
                        </form>
                    )
                };
            }

            class Call extends React.Component {
                render() {
                    return (
                        <section className='h-container flex-child' style={{border:'none', margin:'10px', maxWidth:'30%'}}>
                            {this.props.rolls}
                        </section>
                    )
                }
            }

            class Roll extends React.Component {
                render() {                    
                    let res = this.props.roll.result + (this.props.roll.critResult || 0);
                    let label = this.props.roll.label || '';
                    let fullString = this.props.roll.fullString || '';
                    let critString = this.props.roll.critString || '';
                    let dice = this.props.roll.dice.map((x,i) => <DieImage key={`rollImage#${i}}`} die={x} />);
                    return (
                        <div className='flex-child tooltip' style={{'margin':'-1px', 'marginBottom':'0px'}}>
                            {dice}
                            <p>{res}<span style={{fontSize:'.75em'}}> {label}</span></p>
                            <span className='tooltiptext'>{fullString}<br />{critString}</span>
                        </div>
                    );
                }
            }

            class DieImage extends React.Component {
                render() {
                    let fileName = 'static/';
                    let colorOrGray = this.props.die.kept? 'dice/' : 'gray_dice/';
                    fileName = `${fileName}${colorOrGray}d${this.props.die.sides}_${this.props.die.num}.svg`;
                    return (
                        <img src={fileName} height='50px' />
                    );
                }
            }

            class Aliases extends React.Component {
                render() {
                    let aliases = Object.keys(this.props.aliases).map(x => <p>{x}</p>);
                    return (
                        <div className='flex-child aliases'>
                            <form style={{padding:'5px'}}>
                                <label className='h2'>Aliases</label>
                                <label className='input'>
                                    <input className='input-file' type='file'/>
                                    Import
                                </label>
                            </form>
                            <div>
                                {aliases}
                            </div>
                        </div>
                    );
                }
            }

            class Log extends React.Component {
                render() {
                    return (
                        <div className='flex-child log'>
                            <form>
                                <label className='h2'>Log</label>
                                <input className='input' type="submit" value="Clear" />
                            </form>
                            <div className='inner-log'>
                            </div>
                        </div>                        
                    );
                }
            }

            ReactDOM.render(<App />, document.getElementById('rolls-display'));
        </script>
    </head>
    <body class='c-container'>
        <div id='overlay-lightbox' class='lightbox'>
            <div id='overlay' class='modal'>
                <h1>Options <button onclick="off()">Close</button></h1>
                <h2>Crit Rules</h2>
                <form method="post">
                    <label>
                        <input type="radio" id="rolltwice" name="crit_rule" value="rolltwice">
                        Double the dice rolled.
                    </label><br>
                    <label>
                        <input type="radio" id="addmaxdice" name="crit_rule" value="addmaxdice">
                        Roll the dice normally, and then add the maximum dice roll.
                    </label><br>
                    <label>
                        <input type="radio" id="doubledice" name="crit_rule" value="doubledice">
                        Roll the dice normally, and then double them.
                    </label><br>
                    <input class='input' type='submit' name='save' value='save'>

                </form>
            </div>
        </div>      
        <script>
            function on() {
                document.getElementById("overlay-lightbox").style.display = "block";
                document.getElementById("overlay").style.display = "block";
            }
            
            function off() {
                document.getElementById("overlay-lightbox").style.display = "none";
                document.getElementById("overlay").style.display = "none";
            } 
        </script>


        <h1>Quick Roll</h1>
        <button onclick="on()">Options</button>
        <section id='rolls-display'>
    </body>
</html>